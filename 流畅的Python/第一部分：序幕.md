# 第一部分：序幕

## Python 数据模型：一致性

### 定义

- 数据模型其实是对 Python 框架的描述，它规范了这门语言自身构建模块的接口，这些模块包括但不限于序列、迭代器、函数、类和上下文管理器

### 自定义数据类型可以表现的跟内置类型一样的秘密

- 处理方式

	- Python 解释器碰到特殊句法时，会使用特殊方法去激活一些基本的对象操作，这些特殊方法的名字以两个下划线开头，以两个下划线结尾（例如```__getitem__``` 方法）

- 可通过特殊方法（magic method or dunder method）实现的语言框架

	- 迭代

		- ```__contains__```

			- 支持 in 但如果没有实现该方法， in 运算符会按顺序做一次迭代搜索

		- ```__len__```

			- 支持 ```len()```

		- ```__getitem__```

			- 成为可迭代的（切片、索引、反向迭代等操作）

		- ```__setitem__```

			- 支持 ```s[i] = xx```

		- ```__iter__```

			- 支持 ```iter``` 和 ```for ... in ...```

		- ```__delitem__```

			- 支持 ```del```

	- 集合类
	- 属性访问
	- 运算符重载

		- ```__abs__```

			- abs 计算绝对值

		- ```__add__```

			- \+

		- ```__mul__```

			- \* 对象做被乘数

		- ```__rmul__```

			- \* 对象做乘数

		- ```__bool__```

			- 布尔

	- 函数和方法的调用
	- 对象的创建和销毁
	- 字符串表示形式和格式化

		- ```__repr__```

			- 字符串表示形式，支持 ```print``` or ```str```

		- ```__str__```

			- 字符串表示形式, 支持 ```str``` or  ```print```
        > [Difference between ```__str__``` and ```__repr__```?](https://stackoverflow.com/questions/1436703/difference-between-str-and-repr)

	- 管理上下文（with 模块）

### 一摞 Python 风格的纸牌

- 体现的思想

	- 可以通过数据模型和一些合成来实现语言框架的功能，而非只能通过继承
    - ```namedtuple```

### 如何使用特殊方法

- 特殊方法的存在是为了被 Python 解释器调用的，你自己并不需要调用他们
- 然而如果是 Python 内置类型， 那么 CPython 会抄个近路，```__len__``` 实际上会返回 PyVarObject 里的 obj_size 属性。相当于直接读值
- 通过内置的函数来使用特殊方法是最好的选择。这些内置函数不仅会调用特殊方法，通常还提供额外的好处，而且对内置的类来说。他们的速度更快
- 不要想当然随意添加特殊方法

### 为什么 ```len``` 不是普通方法

- 实用胜于纯粹，```len``` 的速度会非常快因为 Cpython 会直接从一个 C 结构体里读取对象的长度
- len 不是一个普通的方法是为了让 python 自带的数据可以走后门 abs 也是同理

### 延伸阅读

- Data Model: https://docs.python.org/3/reference/datamodel.html
- Python 技术手册 By: Alex Martelli 
- 元对象

	- 对构建语言本身来讲很重要的对象， 以此为前提，协议也可以看作接口。也就是说元对象协议是对象模型的同义词。它们的意思都是构建核心语言的 API
